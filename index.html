<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MVM Nalbari - Fixed Verifier</title>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        :root { --primary: #00008B; --success: #28a745; --danger: #dc3545; }
        body { font-family: sans-serif; margin: 0; background: #f4f7f6; padding-bottom: 30px; }
        header { background: var(--primary); color: white; padding: 15px; text-align: center; font-weight: bold; }
        .container { max-width: 500px; margin: auto; padding: 15px; }
        
        /* Scanner Container Styling */
        #reader { 
            width: 100%; 
            border: 2px solid var(--primary); 
            border-radius: 12px; 
            overflow: hidden; 
            background: #000;
        }

        .btn-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn { 
            flex: 1; padding: 12px; border: none; border-radius: 8px; 
            cursor: pointer; font-weight: bold; color: white; 
        }
        .btn-cam { background: var(--primary); }
        .btn-file { background: #555; }

        .result-panel { 
            margin-top: 20px; padding: 20px; border-radius: 12px; 
            display: none; text-align: center; border: 2px solid #ccc;
        }
        .valid { background: #d4edda; border-color: var(--success); color: #155724; }
        .invalid { background: #f8d7da; border-color: var(--danger); color: #721c24; }
    </style>
</head>
<body>

<header>MVM ENTRANCE VERIFIER</header>

<div class="container">
    <div class="btn-group">
        <button class="btn btn-cam" onclick="initScanner()"><i class="fa-solid fa-camera"></i> Start Camera</button>
        <label class="btn btn-file" for="qr-input-file"><i class="fa-solid fa-image"></i> Gallery</label>
        <input type="file" id="qr-input-file" accept="image/*" style="display:none">
    </div>

    <div id="reader"></div>

    <div id="resultPanel" class="result-panel">
        <h2 id="statusTitle"></h2>
        <div id="studentDetails"></div>
        <button class="btn" style="background:#333; margin-top:10px;" onclick="resetScanner()">Scan Next</button>
    </div>
</div>

<script>
    const API = 'https://script.google.com/macros/s/AKfycbzPWWCpUt5GPQ1rEGeAIgt79zJMWCZlXbKx_0PvrXDUHJ5QMY1rlC9hhKS5C4KLNCJz/exec';
    let html5QrCode;

    // 1. Start Scanner Function
    function initScanner() {
        if(html5QrCode) { html5QrCode.stop().catch(()=>{}); }
        
        html5QrCode = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 280, height: 150 } };

        html5QrCode.start(
            { facingMode: "environment" }, 
            config, 
            onScanSuccess
        ).catch(err => {
            alert("Camera Error: " + err + ". Ensure you are using HTTPS.");
        });
    }

    // 2. Handle File Upload (Gallery)
    document.getElementById('qr-input-file').addEventListener('change', e => {
        if (e.target.files.length === 0) return;
        const file = e.target.files[0];
        const scanner = new Html5Qrcode("reader");
        scanner.scanFile(file, true)
            .then(onScanSuccess)
            .catch(err => alert("No barcode found in image."));
    });

    // 3. Process Scanned Data
    async function onScanSuccess(decodedText) {
        // Stop camera once scanned
        try { await html5QrCode.stop(); } catch(e){}

        const panel = document.getElementById('resultPanel');
        const title = document.getElementById('statusTitle');
        const info = document.getElementById('studentDetails');

        panel.style.display = "block";
        title.innerText = "Checking Database...";

        try {
            // Decode Base64
            const cleanText = decodedText.replace(/\*/g, "");
            const decoded = atob(cleanText);
            const [sid, dob] = decoded.split('|');

            // API Check
            const res = await fetch(API);
            const json = await res.json();
            const student = json.data.find(x => String(x['Student ID']).toUpperCase() === sid.toUpperCase());

            if (student && String(student['Date of Birth']) === dob) {
                panel.className = "result-panel valid";
                title.innerText = "✅ VERIFIED";
                info.innerHTML = `<b>${student['Student Name']}</b><br>ID: ${sid}<br>Class: ${student['Class']}`;
            } else {
                throw new Error();
            }
        } catch (e) {
            panel.className = "result-panel invalid";
            title.innerText = "❌ INVALID";
            info.innerText = "Student record not found or barcode fake.";
        }
    }

    function resetScanner() {
        document.getElementById('resultPanel').style.display = 'none';
        initScanner();
    }

    // Initialize on start
    window.onload = initScanner;
</script>

</body>
</html>
