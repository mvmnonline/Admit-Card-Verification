<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MVM Nalbari - Examination Verifier</title>
    
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        :root {
            --primary: #00008B;
            --success: #28a745;
            --danger: #dc3545;
            --bg: #f4f7f6;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            background: var(--bg); 
            color: #333; 
            padding-bottom: 50px;
        }

        header { 
            background: var(--primary); 
            color: white; 
            padding: 20px; 
            text-align: center; 
            font-weight: bold; 
            font-size: 1.3rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .container { 
            max-width: 600px; 
            margin: auto; 
            padding: 15px; 
        }

        /* Mode Switcher */
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .control-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: 0.3s;
            color: white;
        }

        .btn-camera { background: var(--primary); }
        .btn-gallery { background: #555; }
        .control-btn:hover { opacity: 0.9; transform: translateY(-1px); }

        /* Scanner Area */
        #reader { 
            width: 100%; 
            border-radius: 15px; 
            overflow: hidden; 
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        }

        /* Result Panel */
        .result-panel { 
            margin-top: 20px; 
            padding: 20px; 
            border-radius: 12px; 
            display: none; 
            text-align: center; 
            animation: fadeIn 0.4s ease-out; 
        }
        
        .valid { background: #d4edda; border: 2px solid #c3e6cb; color: #155724; }
        .invalid { background: #f8d7da; border: 2px solid #f5c6cb; color: #721c24; }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .reset-btn { 
            background: #333; 
            color: white; 
            border: none; 
            padding: 12px 25px; 
            border-radius: 6px; 
            margin-top: 15px; 
            cursor: pointer;
            font-weight: bold;
        }

        /* History Section */
        .history-section { margin-top: 30px; }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .history-card { 
            background: white; 
            padding: 12px 15px; 
            border-radius: 10px; 
            margin-bottom: 10px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-left: 5px solid var(--primary);
        }

        .history-time { font-size: 0.85rem; color: #777; font-weight: bold; }
        
        .empty-msg { text-align: center; color: #999; margin-top: 20px; font-style: italic; }
    </style>
</head>
<body>

<header>
    <i class="fa-solid fa-shield-halved"></i> STAFF VERIFIER: MVM NALBARI
</header>

<div class="container">
    <div class="controls">
        <button class="control-btn btn-camera" onclick="useCamera()">
            <i class="fa-solid fa-camera"></i> Live Scan
        </button>
        <label for="file-input" class="control-btn btn-gallery">
            <i class="fa-solid fa-image"></i> Gallery
        </label>
        <input type="file" id="file-input" accept="image/*" style="display:none;">
    </div>

    <div id="reader"></div>

    <div id="resultPanel" class="result-panel">
        <h2 id="statusTitle"></h2>
        <div id="studentDetails" style="font-size: 1.1rem; line-height: 1.5;"></div>
        <button class="reset-btn" onclick="resetScanner()">Scan Next Student</button>
    </div>

    <div class="history-section">
        <div class="history-header">
            <h3><i class="fa-solid fa-clock-rotate-left"></i> Today's Entries</h3>
            <span id="count-badge" style="background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.9rem;">0 Students</span>
        </div>
        <div id="historyList"></div>
    </div>
</div>

<script>
    // Configuration
    const API = 'https://script.google.com/macros/s/AKfycbzPWWCpUt5GPQ1rEGeAIgt79zJMWCZlXbKx_0PvrXDUHJ5QMY1rlC9hhKS5C4KLNCJz/exec';
    let history = JSON.parse(localStorage.getItem('mvm_scan_history')) || [];
    
    const html5QrCode = new Html5Qrcode("reader");
    const qrConfig = { fps: 10, qrbox: { width: 250, height: 180 } };

    // Initialize Camera
    function useCamera() {
        resetScanner();
        html5QrCode.start({ facingMode: "environment" }, qrConfig, onScanSuccess)
            .catch(err => alert("Camera Error: " + err));
    }

    // Handle Gallery Upload
    document.getElementById('file-input').addEventListener('change', async (e) => {
        if (e.target.files.length === 0) return;
        const file = e.target.files[0];
        
        try {
            // Stop camera if running to free resources
            try { await html5QrCode.stop(); } catch(e) {}
            
            const decodedText = await html5QrCode.scanFile(file, true);
            onScanSuccess(decodedText);
        } catch (err) {
            alert("No clear barcode found in this photo. Please try again or use the camera.");
        }
    });

    // Core Processing Logic
    async function onScanSuccess(decodedText) {
        // Pause scanner
        try { await html5QrCode.pause(); } catch(e) {}

        const panel = document.getElementById('resultPanel');
        const title = document.getElementById('statusTitle');
        const info = document.getElementById('studentDetails');

        panel.style.display = "block";
        panel.className = "result-panel";
        title.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Verifying...';
        info.innerHTML = "Checking database, please wait.";

        try {
            // 1. Decode Base64 Hash
            const cleanHash = decodedText.replace(/\*/g, ""); // Remove Barcode 128 markers
            const decodedString = atob(cleanHash); 
            const [sid, dob] = decodedString.split('|');

            // 2. Fetch from Google Sheets
            const response = await fetch(API);
            const json = await response.json();
            const student = json.data.find(x => 
                String(x['Student ID']).toUpperCase() === sid.toUpperCase() &&
                String(x['Date of Birth']) === dob
            );

            if (student) {
                // Success Case
                panel.className = "result-panel valid";
                title.innerHTML = '<i class="fa-solid fa-circle-check"></i> ACCESS GRANTED';
                info.innerHTML = `
                    <strong style="font-size: 1.4rem;">${student['Student Name']}</strong><br>
                    ID: ${sid} | Roll: ${student['Roll No']}<br>
                    Class: ${student['Class']} - ${student['Section']}
                `;
                saveToHistory(student['Student Name'], sid);
            } else {
                throw new Error("Invalid Record");
            }

        } catch (error) {
            // Failure Case
            panel.className = "result-panel invalid";
            title.innerHTML = '<i class="fa-solid fa-circle-xmark"></i> ACCESS DENIED';
            info.innerHTML = "This barcode is invalid or the student details do not match our database.";
        }
    }

    function saveToHistory(name, id) {
        const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        // Don't add same student twice in history
        if (!history.some(item => item.id === id)) {
            history.unshift({ name, id, time: timestamp });
            localStorage.setItem('mvm_scan_history', JSON.stringify(history));
            updateHistoryUI();
        }
    }

    function updateHistoryUI() {
        const list = document.getElementById('historyList');
        const countBadge = document.getElementById('count-badge');
        
        countBadge.innerText = `${history.length} Students`;

        if (history.length === 0) {
            list.innerHTML = '<div class="empty-msg">No scans yet today.</div>';
            return;
        }

        list.innerHTML = history.map(item => `
            <div class="history-card">
                <div>
                    <strong>${item.name}</strong><br>
                    <small style="color: #666;">ID: ${item.id}</small>
                </div>
                <div class="history-time">${item.time}</div>
            </div>
        `).join('');
    }

    function resetScanner() {
        document.getElementById('resultPanel').style.display = 'none';
        try { html5QrCode.resume(); } catch(e) {}
    }

    // Auto-start camera on page load
    window.addEventListener('load', () => {
        useCamera();
        updateHistoryUI();
    });
</script>

</body>
</html>
